name: Hourly Content Aggregation

on:
  schedule:
    - cron: '0 * * * *'   # æ¯å°æ—¶æ•´ç‚¹ï¼ˆUTCï¼‰
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘

# é˜²å¹¶å‘äº’è¸©ï¼ˆåŒä¸€åˆ†æ”¯ä»…ä¿ç•™ä¸€ä¸ªåœ¨è·‘çš„å®ä¾‹ï¼‰
concurrency:
  group: aggregator-${{ github.ref }}
  cancel-in-progress: true

# å…è®¸å†™å…¥ä»“åº“ï¼ˆæäº¤/æ¨é€ï¼‰
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      # â†“â†“â†“ å¯æŒ‰éœ€åœ¨ä»“åº“/ç¯å¢ƒé‡Œæ”¹
      SUMMARIZE_CONCURRENCY: 4      # å—æ§å¹¶å‘ï¼ˆ3~5 æ¨èï¼‰
      MAX_ARTICLES_PER_RUN: 0       # 0=ä¸é™ï¼›å¦‚éœ€é™æµå¯è®¾ 20/50 ç­‰
      OPENAI_MODEL: gpt-4o-mini     # é»˜è®¤æ›´çœé’±çš„æ¨¡å‹

    steps:
      - name: Checkout main (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      # âœ… å…ˆåŒæ­¥ mainï¼ˆå·¥ä½œåŒºå¹²å‡€ï¼Œrebase é¡ºç•…ï¼‰
      - name: Git config & pre-sync main
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git switch main || git switch -c main
          git fetch origin main
          git pull --rebase origin main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'                        # âœ… pip ç¼“å­˜
          cache-dependency-path: requirements.txt

      - name: Cache NLTK/newspaper data
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/nltk
            ~/.cache/newspaper
          key: ${{ runner.os }}-nltk-newspaper-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -q

      - name: Run aggregator script
        run: |
          python scripts/aggregator.py

      - name: Generate sitemap.xml
        run: |
          python scripts/generate_sitemap.py

      - name: Commit & push (safe with one retry)
        run: |
          set -e
          git add posts/ sitemap.xml
          git commit -m "ğŸ¤– Auto-update content and sitemap" || { echo "Nothing to commit"; exit 0; }
          git push origin HEAD:main || {
            echo "Push failed; refetch + rebase then retry..."
            git fetch origin main
            git pull --rebase origin main
            git push origin HEAD:main
          }
