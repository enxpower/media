name: Hourly Content Aggregation

on:
  schedule:
    - cron: '0 * * * *'   # 每小时整点（UTC）
  workflow_dispatch:        # 允许手动触发

# 防并发互踩（同一分支仅保留一个在跑的实例）
concurrency:
  group: aggregator-${{ github.ref }}
  cancel-in-progress: true

# 允许写入仓库（提交/推送）
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      # ↓↓↓ 可按需在仓库/环境里改
      SUMMARIZE_CONCURRENCY: 4      # 受控并发（3~5 推荐）
      MAX_ARTICLES_PER_RUN: 0       # 0=不限；如需限流可设 20/50 等
      OPENAI_MODEL: gpt-4o-mini     # 默认更省钱的模型

    steps:
      - name: Checkout main (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      # ✅ 先同步 main（工作区干净，rebase 顺畅）
      - name: Git config & pre-sync main
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git switch main || git switch -c main
          git fetch origin main
          git pull --rebase origin main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'                        # ✅ pip 缓存
          cache-dependency-path: requirements.txt

      - name: Cache NLTK/newspaper data
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/nltk
            ~/.cache/newspaper
          key: ${{ runner.os }}-nltk-newspaper-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -q

      - name: Run aggregator script
        run: |
          python scripts/aggregator.py

      - name: Generate sitemap.xml
        run: |
          python scripts/generate_sitemap.py

      - name: Commit & push (safe with one retry)
        run: |
          set -e
          git add posts/ sitemap.xml
          git commit -m "🤖 Auto-update content and sitemap" || { echo "Nothing to commit"; exit 0; }
          git push origin HEAD:main || {
            echo "Push failed; refetch + rebase then retry..."
            git fetch origin main
            git pull --rebase origin main
            git push origin HEAD:main
          }
