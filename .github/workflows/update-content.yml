name: Hourly Content Aggregation

on:
  schedule:
    - cron: '0 * * * *'      # 每小时（UTC）
  workflow_dispatch:

concurrency:
  group: aggregator-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: gpt-4o-mini
      SUMMARIZE_CONCURRENCY: 6
      MAX_ARTICLES_PER_RUN: 50
    steps:
      - name: Checkout main (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      # 🛠️ 先把本地与远端 main 对齐，再开始生成内容
      - name: Git config & pre-sync main
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git switch main || git switch -c main
          git fetch --prune origin
          git pull --rebase origin main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Cache NLTK/newspaper data
        uses: actions/cache@v4
        with:
          path: ~/.cache
          key: nltk-newspaper-${{ runner.os }}-v1

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          python -m nltk.downloader punkt || true

      - name: Run aggregator script
        run: |
          python scripts/aggregator.py

      - name: Generate sitemap.xml
        run: |
          python scripts/generate_sitemap.py

      # ✅ 生成完再提交；如竞态失败，抓取最新后重试一次
      - name: Commit & push (safe with one retry)
        run: |
          set -e
          git add posts/ sitemap.xml
          git commit -m "🤖 Auto-update content and sitemap" || { echo "Nothing to commit"; exit 0; }
          git push origin HEAD:main || {
            echo "Push failed; refetch + rebase then retry..."
            git fetch origin main
            git pull --rebase origin main
            git push origin HEAD:main
          }
