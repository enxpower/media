name: Hourly Content Aggregation

on:
  schedule:
    - cron: '0 * * * *'   # æ¯å°æ—¶æ•´ç‚¹ï¼ˆUTCï¼‰
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘

# é˜²å¹¶å‘äº’è¸©ï¼ˆåŒä¸€åˆ†æ”¯ä»…ä¿ç•™ä¸€ä¸ªåœ¨è·‘çš„å®ä¾‹ï¼‰
concurrency:
  group: aggregator-${{ github.ref }}
  cancel-in-progress: true

# å…è®¸å†™å…¥ä»“åº“ï¼ˆæäº¤/æ¨é€ï¼‰
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout main (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # å¿…é¡»ï¼šæ”¯æŒ rebase
          ref: main           # æ˜ç¡®ä»¥ main ä¸ºå·¥ä½œåˆ†æ”¯

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install newspaper3k feedparser openai lxml_html_clean

      - name: Run aggregator script
        run: |
          python scripts/aggregator.py

      - name: Generate sitemap.xml
        run: |
          python scripts/generate_sitemap.py

      # å…³é”®ï¼šæ¨é€å‰å…ˆåŒæ­¥è¿œç«¯ mainï¼Œé¿å… non-fast-forward
      - name: Git config & sync latest main
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git fetch origin main
          git pull --rebase origin main

      - name: Commit & push (safe with one retry)
        run: |
          set -e
          git add posts/ sitemap.xml
          git commit -m "ğŸ¤– Auto-update content and sitemap" || { echo "Nothing to commit"; exit 0; }
          # ç¬¬ä¸€æ¬¡æ¨é€ï¼›è‹¥å› ç«æ€å¤±è´¥ï¼Œåˆ™åŒæ­¥åé‡è¯•ä¸€æ¬¡
          git push origin HEAD:main || {
            echo "Push failed; refetch + rebase then retry..."
            git fetch origin main
            git pull --rebase origin main
            git push origin HEAD:main
          }
