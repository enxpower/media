name: Sync private content to public

on:
  schedule:
    - cron: "17 * * * *"   # 每小时第 17 分（UTC）
  workflow_dispatch: {}     # 也支持手动触发

permissions:
  contents: write

concurrency:
  group: sync-content
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout public repo
        uses: actions/checkout@v4

      # 用 GitHub App 生成只读安装令牌（无需 Installation ID）
      - name: Create installation token (read-only)
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: enxpower            # 你的账户/组织名
          repositories: content-ops  # 你的“私库”名

      - name: Checkout private content repo (read-only)
        uses: actions/checkout@v4
        with:
          repository: enxpower/content-ops
          ref: main
          token: ${{ steps.app_token.outputs.token }}
          path: _content

      - name: Sync selected content into public repo
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p static/data ads downloads

          # 1) JSON 配置 → /static/data/
          if [ -d _content/json ]; then
            rsync -av --delete _content/json/ static/data/
          fi

          # 2) 广告/横幅素材 → /ads/
          if [ -d _content/ads ]; then
            rsync -av --delete _content/ads/ ads/
          fi

          # 3) 下载文件（PDF/ZIP等） → /downloads/
          if [ -d _content/downloads ]; then
            rsync -av --delete _content/downloads/ downloads/
          fi

      - name: Commit & push if changes
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions"
          git config user.email "github-actions@github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: sync private content"
            git push
          fi
